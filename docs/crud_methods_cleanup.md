# CRUDBlueprint Methods/Skip_Methods Logic Cleanup

## Summary

Cleaned up and clarified the logic for controlling which CRUD methods are generated by `CRUDBlueprint` through the `methods` and `skip_methods` parameters.

## Changes Made

### 1. Enhanced Documentation

**File: `flask_more_smorest/crud/crud_blueprint.py`**

- Added comprehensive docstring to `CRUDBlueprint` class explaining both `methods` and `skip_methods` parameters
- Included multiple usage examples showing:
  - Basic usage (all methods enabled)
  - List mode (whitelist specific methods)
  - Dict mode (configure specific methods with all enabled by default)
  - Using `skip_methods` to disable defaults
- Added detailed docstrings to `_normalize_methods()` and `_build_config()` explaining the evaluation logic

### 2. Clarified Behavior

**Key behavioral improvements:**

#### List Mode (`methods=[...]`)
- **Explicit whitelist**: Only specified methods are enabled
- Example: `methods=[CRUDMethod.INDEX, CRUDMethod.GET]` → Only INDEX and GET are created

#### Dict Mode (`methods={...}`)
- **All enabled by default**: When using a dict, ALL methods are enabled unless explicitly disabled
- Dict values can be:
  - `True`: Enable with defaults (redundant but allowed)
  - `False`: Explicitly disable this method
  - `MethodConfig` dict: Enable with custom configuration (schema, admin_only, etc.)
- Example: `methods={CRUDMethod.POST: {"schema": "CustomSchema"}}` → All 5 methods enabled, POST uses custom schema

#### skip_methods
- Applied **after** methods normalization
- Removes methods from the final set
- Useful when you want "all except these"
- Works with both list and dict modes

### 3. Improved Method Normalization

**File: `flask_more_smorest/crud/crud_blueprint.py`**

**In `_normalize_methods()`:**
- Now explicitly enables all methods when dict mode is used (before processing overrides)
- Better error messages with type information
- Clearer flow: default all → apply overrides → return normalized

**In `_build_config()`:**
- Added warning when both dict with `False` AND `skip_methods` are used for same method (redundant)
- Better documentation of the two-step process
- More informative comments

### 4. Fixed Edge Cases

**Empty methods handling:**
- Empty methods list `[]` → No routes created (correct)
- Empty methods dict `{}` → All routes created (dict mode default)
- GenericCRUD route only registered if it has at least one method

### 5. Updated README

**File: `README.md`**

- Rewrote "Controlling generated endpoints" section with three clear options
- Added "Key behaviors" summary explaining list vs dict mode
- Included concrete examples for each usage pattern
- Clarified that dict mode enables all by default

### 6. Comprehensive Test Coverage

**New file: `tests/unit/test_crud_methods_logic.py`**

Added 11 tests covering:
- ✅ List mode whitelist behavior
- ✅ Dict mode enables all by default
- ✅ Dict with `False` disables methods
- ✅ skip_methods removes after normalization
- ✅ skip_methods works with list mode
- ✅ Redundant skip_methods triggers warning
- ✅ Dict with `True` values
- ✅ Invalid dict values raise TypeError
- ✅ Invalid methods type raises TypeError
- ✅ Empty methods list creates no routes
- ✅ Empty methods dict enables all routes

All existing 120 tests still pass.

## Migration Guide

### No Breaking Changes

The cleanup maintains backward compatibility. Existing code will work exactly as before.

### Recommended Patterns

**Before (unclear):**
```python
# Unclear: Are other methods enabled or not?
bp = CRUDBlueprint(
    "users", __name__,
    model="Critter",
    methods={CRUDMethod.POST: {"schema": "UserWriteSchema"}}
)
```

**After (clear):**
```python
# Clear: All methods enabled, POST customized
bp = CRUDBlueprint(
    "users", __name__,
    model="Critter",
    methods={CRUDMethod.POST: {"schema": "UserWriteSchema"}}
)
# Result: INDEX, GET, POST (custom), PATCH, DELETE all created
```

**Before (redundant):**
```python
bp = CRUDBlueprint(
    "users", __name__,
    model="Critter",
    methods={CRUDMethod.PATCH: False},
    skip_methods=[CRUDMethod.PATCH]  # Redundant!
)
```

**After (warning issued):**
```python
# Now triggers a UserWarning about redundancy
# Choose one approach:

# Option A: Use dict False
methods={CRUDMethod.PATCH: False}

# Option B: Use skip_methods
skip_methods=[CRUDMethod.PATCH]
```

## Benefits

1. **Clearer documentation**: Users understand list vs dict behavior
2. **Better error messages**: Type information included
3. **Helpful warnings**: Detect redundant configuration
4. **Edge cases handled**: Empty methods work correctly
5. **Comprehensive tests**: All behaviors verified
6. **No breaking changes**: Existing code continues to work

## Implementation Details

### Evaluation Order

```
1. Normalize methods parameter:
   - List mode: Create dict with only listed methods
   - Dict mode: Start with ALL methods, apply overrides

2. Apply skip_methods:
   - Remove each method in skip_methods list
   - Warn if already disabled in dict

3. Return final configuration
```

### Example Flow

**Input:**
```python
methods={
    CRUDMethod.POST: {"schema": "WriteSchema"},
    CRUDMethod.DELETE: False,
}
skip_methods=[CRUDMethod.PATCH]
```

**Step 1 - Normalize:**
```python
{
    CRUDMethod.INDEX: {},    # Default enabled (dict mode)
    CRUDMethod.GET: {},      # Default enabled
    CRUDMethod.POST: {"schema": "WriteSchema"},  # Custom config
    CRUDMethod.PATCH: {},    # Default enabled
    # CRUDMethod.DELETE removed (False in dict)
}
```

**Step 2 - Apply skip_methods:**
```python
{
    CRUDMethod.INDEX: {},
    CRUDMethod.GET: {},
    CRUDMethod.POST: {"schema": "WriteSchema"},
    # CRUDMethod.PATCH removed (in skip_methods)
}
```

**Final Result:**
- INDEX (default)
- GET (default)
- POST (custom schema)

## Testing

Run the new tests:
```bash
pytest tests/unit/test_crud_methods_logic.py -v
```

Run all tests to verify no regressions:
```bash
pytest tests/ -v
```

All 131 tests pass ✅
